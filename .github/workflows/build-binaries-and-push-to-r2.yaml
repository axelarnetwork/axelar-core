name: Upload core binary to Cloudflare R2 bucket


on:
    push:


jobs:
    preparation:
        name: Preparation
        runs-on: ubuntu-22.04
        permissions:
            contents: write
            packages: write
            id-token: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                fetch-depth: "0"
                path: axelar-core
                submodules: recursive
            
            - name: Build axelard binary with commit hash
              id: build-binary
              run: |
                mkdir ./binary_file/
                cd axelar-core
                make build
                commit_hash=$(git rev-parse --short HEAD)
                echo "The commit hash: $commit_hash"
                cd ..
                sudo mv axelar-core/bin/axelard ./binary_file/axelard_$commit_hash
                echo "binary-directory=./binary_file" >> $GITHUB_OUTPUT
              
            - name: List contents of root directory
              run: ls -la
          
            - uses: ryand56/r2-upload-action@latest
              with:
                r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
                r2-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_CF }}
                r2-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_CF }}
                r2-bucket: ${{ secrets.R2_BUCKET }}
                source-dir: ${{ steps.build-binary.outputs.binary-directory }}
                destination-dir: ./pre-releases/axelard/