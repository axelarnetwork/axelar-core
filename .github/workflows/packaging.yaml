name: Package linux binaries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Github tag vx.x.x
        required: true
        default: latest


jobs:
  package-binaries:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-22.04]
        arch: [amd64]

    permissions:
      contents: write
      packages: write
      id-token: write

    steps:

      - name: Validate tag
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          if [[ $SEMVER =~ v[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3} ]]; then echo "Tag is okay" && exit 0; else echo "invalid tag" && exit 1; fi
          aws s3 ls s3://axelar-releases/axelard/"$SEMVER" && echo "tag already exists, use a new one" && exit 1

      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: '0'
          submodules: recursive

      - name: Install prerequisites
        run: |
          sudo apt-get install -y gcc dpkg-dev gpg

      - name: Create folder structures for Linux
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          VER=$(echo $SEMVER | tr -d 'v')
          mkdir -p ~/linux/axelard_$VER-1_amd64/usr/bin/
          mkdir -p ~/linux/axelard_$VER-1_amd64/DEBIAN/
          mkdir -p ~/linux/axelard_$VER-1_arm64/usr/bin/
          mkdir -p ~/linux/axelard_$VER-1_arm64/DEBIAN/
          mkdir -p ~/linux/axelard_$VER-1_arm/usr/bin/
          mkdir -p ~/linux/axelard_$VER-1_arm/DEBIAN/    
          
      - name: Get binaries
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          VER=$(echo $SEMVER | tr -d 'v')
          wget -O ~/linux/axelard_$VER-1_amd64/usr/bin/axelard --no-check-certificate https://github.com/axelarnetwork/axelar-core/releases/download/v0.31.3/axelard-linux-amd64-v0.31.3
          chmod 755 ~/linux/axelard_$VER-1_amd64/usr/bin/axelard
          wget -O ~/linux/axelard_$VER-1_arm64/usr/bin/axelard --no-check-certificate https://github.com/axelarnetwork/axelar-core/releases/download/v0.31.3/axelard-linux-arm64-v0.31.3
          chmod 755 ~/linux/axelard_$VER-1_arm64/usr/bin/axelard
          wget -O ~/linux/axelard_$VER-1_arm/usr/bin/axelard --no-check-certificate https://github.com/axelarnetwork/axelar-core/releases/download/v0.31.3/axelard-linux-arm-v0.31.3
          chmod 755 ~/linux/axelard_$VER-1_arm/usr/bin/axelard  
          
      - name: Create control files
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          VER=$(echo $SEMVER | tr -d 'v')
          echo "Package: axelard
          Version: $VER
          Maintainer: axelar <devops@axelar.network>
          Architecture: amd64
          Homepage: https://axelar.network
          Description: axelard binary for Linux amd64" \
          > ~/linux/axelard_$VER-1_amd64/DEBIAN/control
          echo "Package: axelard
          Version: $VER
          Maintainer: axelar <devops@axelar.network>
          Architecture: arm64
          Homepage: https://axelar.network
          Description: axelard binary for Linux arm64" \
          > ~/linux/axelard_$VER-1_arm64/DEBIAN/control
          echo "Package: axelard
          Version: $VER
          Maintainer: axelar <devops@axelar.network>
          Architecture: arm
          Homepage: https://axelar.network
          Description: axelard binary for Linux arm" \
          > ~/linux/axelard_$VER-1_arm/DEBIAN/control
          
      - name: Build the packages
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          VER=$(echo $SEMVER | tr -d 'v')
          dpkg --build ~/linux/axelard_$VER-1_amd64
          dpkg --build ~/linux/axelard_$VER-1_arm64
          dpkg --build ~/linux/axelard_$VER-1_arm
          
      - name: Check the packages
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          VER=$(echo $SEMVER | tr -d 'v')
          dpkg-deb --info ~/linux/axelard_$VER-1_amd64.deb
          dpkg-deb --contents ~/linux/axelard_$VER-1_amd64.deb
          dpkg-deb --info ~/linux/axelard_$VER-1_arm64.deb
          dpkg-deb --contents ~/linux/axelard_$VER-1_arm64.deb
          dpkg-deb --info ~/linux/axelard_$VER-1_arm.deb
          dpkg-deb --contents ~/linux/axelard_$VER-1_arm.deb
          
      - name: Install the package for amd64
        env:
          SEMVER: ${{ github.event.inputs.tag }}
        run: |
          VER=$(echo $SEMVER | tr -d 'v')
          sudo apt-get install -f ~/linux/axelard_$VER-1_amd64.deb
          
      - name: check installed binary for amd64
        run: | 
          which axelard
          axelard version